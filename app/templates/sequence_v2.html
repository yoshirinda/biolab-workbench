{% extends "base.html" %}

{% block title %}Sequence Management - BioLab Workbench{% endblock %}

{% block content %}
<style>
    body.seq-dark-mode { background: #f5f5f5; }
    .seq-main-container { display: flex; height: calc(100vh - 120px); }
    .seq-sidebar { width: 300px; background: #fff; border-right: 1px solid #ddd; overflow-y: auto; padding: 0; }
    .seq-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .seq-toolbar { background: #f9f9f9; border-bottom: 1px solid #ddd; padding: 10px; }
    .seq-editor { flex: 1; display: flex; overflow: hidden; }
    .seq-viewer-panel { flex: 1; overflow-y: auto; padding: 15px; }
    .seq-features-panel { width: 350px; background: #fafafa; border-left: 1px solid #ddd; overflow-y: auto; padding: 15px; }

    /* Sidebar Tree */
    .seq-tree { list-style: none; margin: 0; padding: 0; }
    .seq-tree-item { margin: 0; border-left: 3px solid transparent; }
    .seq-tree-item.active { border-left-color: #0d6efd; background: #f0f6ff; }
    .seq-tree-toggle { background: none; border: none; cursor: pointer; padding: 3px 5px; color: #666; }
    .seq-tree-label { padding: 6px 8px; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 6px; font-size: 13px; }
    .seq-tree-label:hover { background: #f5f5f5; }
    .seq-tree-label.collection { color: #666; font-weight: 500; }
    .seq-tree-label.sequence { color: #555; padding-left: 30px; }
    .seq-tree-children { list-style: none; margin: 0; padding-left: 15px; }

    /* New Feature Viewer Styles */
    .feature-map-container {
        position: relative;
        width: 100%;
        margin-bottom: 20px;
        padding: 10px;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
    }
    .ruler-track {
        position: relative;
        height: 20px;
        background: #f0f0f0;
        border-radius: 3px;
        border: 1px solid #ccc;
    }
    .ruler-tick {
        position: absolute;
        width: 1px;
        height: 5px;
        background: #999;
    }
    .ruler-label {
        position: absolute;
        top: 5px;
        font-size: 10px;
        color: #666;
        transform: translateX(-50%);
    }
    .lanes-container {
        position: relative;
        margin-top: 5px;
    }
    .feature-lane {
        position: relative;
        height: 22px; /* Height for each feature + padding */
    }
    .feature-element {
        position: absolute;
        height: 16px;
        top: 3px;
        border-radius: 3px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border: 1px solid rgba(0,0,0,0.2);
    }
    .feature-element:hover {
        filter: brightness(1.1);
    }
    .feature-label-text {
        color: white;
        font-size: 10px;
        font-weight: bold;
        text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
        white-space: nowrap;
        padding: 0 4px;
    }

    /* Sequence Text Viewer */
    .seq-line { white-space: nowrap; font-family: 'Courier New', monospace; margin: 2px 0; font-size: 12px; }
    .seq-idx { color: #999; margin-right: 8px; display: inline-block; width: 50px; text-align: right; user-select: none; }
    .seq-base { display: inline-block; padding: 2px 1px; border-radius: 2px; cursor: default; user-select: none; line-height: 1.4; }
    .seq-base.selected { outline: 2px solid #0d6efd; }

    /* Other styles */
    .seq-header { margin-bottom: 10px; padding: 8px; background: #f0f6ff; border-radius: 4px; border: 1px solid #cce5ff; }
    .feature-control { background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-bottom: 8px; }
    .feature-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 12px; }
    .feature-color-dot { width: 14px; height: 14px; border-radius: 3px; cursor: pointer; }
</style>

<div class="seq-main-container">
    <!-- Left Sidebar: Project & Collection Tree -->
    <div class="seq-sidebar">
        <div style="padding: 12px 10px; border-bottom: 1px solid #ddd;">
            <button class="btn btn-sm btn-primary w-100 mb-2" onclick="showImportModal()">
                <i class="bi bi-plus-circle"></i> Import Sequences
            </button>
            <button class="btn btn-sm btn-secondary w-100" onclick="showCreateProjectModal()">
                <i class="bi bi-folder-plus"></i> New Project
            </button>
        </div>
        <ul class="seq-tree" id="projectTree">
            <!-- Projects will be loaded here by JS -->
        </ul>
    </div>

    <!-- Right Content Area -->
    <div class="seq-content">
        <!-- Toolbar -->
        <div class="seq-toolbar">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span id="currentProjectName" class="fw-bold">No project selected</span>
                    <span id="sequenceCountBadge" class="badge bg-primary ms-2">0 sequences</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportCurrentProject()">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
        </div>

        <!-- Editor Area -->
        <div class="seq-editor">
            <!-- Sequence Viewer & List -->
            <div class="seq-viewer-panel">
                <!-- Sequence List for current project -->
                <div class="table-responsive mb-3">
                    <table class="table table-sm table-hover align-middle mb-0" id="sequenceListTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 30px;"><input type="checkbox" id="selectAllSeqs" onchange="toggleSelectAllSeqs(this.checked)"></th>
                                <th>Name</th>
                                <th style="width: 80px;">Length</th>
                                <th style="width: 100px;">Type</th>
                                <th style="width: 80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sequenceListBody">
                            <tr><td colspan="5" class="text-center text-muted">Select a project to view sequences</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Sequence Viewer -->
                <div id="viewerContainer" style="display:none;">
                    <div class="seq-header" id="sequenceHeaderDiv">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong id="viewerSeqName">Sequence</strong>
                                <span class="badge bg-info ms-2" id="viewerSeqType">nucleotide</span>
                                <span class="badge bg-secondary ms-1" id="viewerSeqLen">0 bp</span>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="editSequenceContent()">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="featureMapContainer" class="feature-map-container">
                        <!-- Feature map will be rendered here by JS -->
                    </div>

                    <div id="sequenceTextContainer" class="font-monospace" style="user-select: none;">
                        <!-- Sequence text will be rendered here by JS -->
                    </div>
                </div>
                <div id="noViewerSelected" class="text-center text-muted mt-5">
                    <p>Select a sequence to view details</p>
                </div>
            </div>

            <!-- Right Panel: Features & Annotations -->
            <div class="seq-features-panel">
                <h6><i class="bi bi-bookmark-plus"></i> Annotation Panel</h6>
                <hr class="my-2">
                <div id="annotationPanelContent" style="display:none;">
                    <!-- Annotation Notes -->
                    <div class="mb-3">
                        <label class="form-label small">Notes</label>
                        <textarea class="form-control form-control-sm" id="annotationNotes" rows="3" placeholder="Add notes..."></textarea>
                        <button class="btn btn-sm btn-primary mt-1 w-100" onclick="saveAnnotationNotes()">Save Notes</button>
                    </div>

                    <!-- Feature Adding Form -->
                    <div class="feature-control">
                        <div class="fw-bold mb-2">Add Feature</div>
                        <div class="feature-row">
                            <label class="small" style="width: 35px;">Start</label>
                            <input type="number" class="form-control form-control-sm" id="featureStart" min="1" style="flex:1;">
                        </div>
                        <div class="feature-row">
                            <label class="small" style="width: 35px;">End</label>
                            <input type="number" class="form-control form-control-sm" id="featureEnd" min="1" style="flex:1;">
                        </div>
                        <div class="feature-row">
                            <label class="small" style="width: 35px;">Type</label>
                            <input type="text" class="form-control form-control-sm" id="featureType" placeholder="CDS" style="flex:1;">
                        </div>
                        <div class="feature-row">
                            <label class="small" style="width: 35px;">Label</label>
                            <input type="text" class="form-control form-control-sm" id="featureLabel" placeholder="Name" style="flex:1;">
                        </div>
                        <div class="feature-row">
                            <label class="small" style="width: 35px;">Color</label>
                            <input type="color" class="form-control form-control-sm" id="featureColor" value="#ffcc66" style="flex:1;height:32px;">
                        </div>
                        <button class="btn btn-sm btn-success w-100 mt-2" onclick="addFeatureFromForm()">
                            <i class="bi bi-plus"></i> Add Feature
                        </button>
                    </div>

                    <!-- Feature List -->
                    <div>
                        <div class="fw-bold mb-2">Features</div>
                        <div id="featureListDiv" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-muted small">No features</div>
                        </div>
                    </div>
                </div>
                <div id="noAnnotationSelected" class="text-muted small">Select a sequence to manage annotations.</div>

            </div>
        </div>
    </div>
</div>

<!-- Modals -->

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-upload"></i> Import Sequences</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Save to Project</label>
                    <select class="form-select" id="importProjectSelect">
                        <!-- Project options will be loaded here -->
                    </select>
                </div>
                <hr>
                <div class="mb-3">
                    <label class="form-label">Import from</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="importSource" id="importSourceText" value="text" checked>
                        <label class="btn btn-outline-primary" for="importSourceText">Paste Text</label>
                        
                        <input type="radio" class="btn-check" name="importSource" id="importSourceFile" value="file">
                        <label class="btn btn-outline-primary" for="importSourceFile">Upload File</label>
                    </div>
                </div>
                <div id="importTextDiv" class="mb-3">
                    <label class="form-label">FASTA Formatted Text</label>
                    <textarea class="form-control" id="importTextArea" rows="8"></textarea>
                </div>
                <div id="importFileDiv" class="mb-3 d-none">
                    <label class="form-label">FASTA File</label>
                    <input type="file" class="form-control" id="importFileInput" accept=".fasta,.fa,.faa,.fna,.txt">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performImport()">
                    <span id="importSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Import
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Project Modal -->
<div class="modal fade" id="createProjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-folder-plus"></i> Create New Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-control" id="newProjectName" placeholder="e.g., My Arabidopsis Genes">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description (Optional)</label>
                    <textarea class="form-control" id="newProjectDesc" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createNewProject()">Create</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- URLs and Constants ---
    const API_URLS = {
        import: '{{ url_for("sequence.import_sequences") }}',
        projects: '{{ url_for("sequence.get_projects") }}',
        project: (id) => `{{ url_for("sequence.get_projects") }}/${id}`,
        createProject: '{{ url_for("sequence.create_new_project") }}',
        addSequences: (id) => `{{ url_for("sequence.get_projects") }}/${id}/sequences`,
    };
    const FEATURE_COLORS = ['#ffcc66', '#9bd0f5', '#c3f0c8', '#f8b4b4', '#d1c4e9', '#c8e6c9', '#ffe0b2'];

    // --- Application State ---
    let projects = [];
    let currentProject = null;
    let currentSequence = null;
    let importModalInstance = null;
    let createProjectModalInstance = null;

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        importModalInstance = new bootstrap.Modal(document.getElementById('importModal'));
        createProjectModalInstance = new bootstrap.Modal(document.getElementById('createProjectModal'));
        await loadProjects();
        renderProjectTree();
        setupEventListeners();
    });

    function setupEventListeners() {
        // Modal import source toggle
        document.querySelectorAll('input[name="importSource"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                document.getElementById('importTextDiv').classList.toggle('d-none', e.target.value !== 'text');
                document.getElementById('importFileDiv').classList.toggle('d-none', e.target.value !== 'file');
            });
        });
    }

    // --- API & Data Functions ---
    async function apiRequest(url, method = 'GET', body = null, isFormData = false) {
        try {
            const options = { method };
            if (!isFormData) {
                options.headers = { 'Content-Type': 'application/json' };
                if (body) options.body = JSON.stringify(body);
            } else {
                if (body) options.body = body;
            }
            
            const response = await fetch(url, options);
            const responseData = await response.json();

            if (!response.ok) {
                throw new Error(responseData.error || `HTTP error! status: ${response.status}`);
            }
            return responseData;
        } catch (error) {
            console.error('API Request Error:', error);
            showAlert('danger', error.message);
            return null;
        }
    }

    async function loadProjects() {
        const data = await apiRequest(API_URLS.projects);
        if (data && data.success) {
            projects = data.projects;
        }
    }

    // --- Rendering Functions ---
    function renderProjectTree() {
        const tree = document.getElementById('projectTree');
        if (!projects || projects.length === 0) {
            tree.innerHTML = '<li class="p-2 text-muted small">No projects found.</li>';
            return;
        }
        tree.innerHTML = projects.map(p => `
            <li class="seq-tree-item" id="tree-item-${p.id}">
                <div class="seq-tree-label" onclick="selectProject('${p.id}')">
                    <i class="bi bi-folder"></i> <span>${p.name}</span>
                </div>
            </li>
        `).join('');
    }

    async function selectProject(projectId) {
        document.querySelectorAll('.seq-tree-item').forEach(el => el.classList.remove('active'));
        const treeItem = document.getElementById(`tree-item-${projectId}`);
        if (treeItem) treeItem.classList.add('active');
        
        const projectData = await apiRequest(API_URLS.project(projectId));
        if (projectData && projectData.success) {
            currentProject = projectData.project;
            currentSequence = null;
            updateSequenceList();
            clearViewer();
            document.getElementById('currentProjectName').textContent = currentProject.name;
        }
    }
    
    function updateSequenceList() {
        const tbody = document.getElementById('sequenceListBody');
        const sequences = currentProject?.sequences || [];
        document.getElementById('sequenceCountBadge').textContent = `${sequences.length} sequences`;

        if (sequences.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No sequences in this project</td></tr>';
            return;
        }

        tbody.innerHTML = sequences.map(seq => `
            <tr id="seq-row-${seq.id}" style="cursor:pointer;" onclick="viewSequence('${seq.id}')">
                <td><input type="checkbox" class="seq-checkbox" data-id="${seq.id}"></td>
                <td>${seq.id}</td>
                <td>${seq.length}</td>
                <td><span class="badge bg-${seq.type === 'nucleotide' ? 'success' : 'info'}">${seq.type}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteSequence('${seq.id}')" title="Delete"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `).join('');
    }

    function viewSequence(sequenceId) {
        currentSequence = currentProject.sequences.find(s => s.id === sequenceId);
        if (!currentSequence) return;
        
        document.querySelectorAll('#sequenceListBody tr').forEach(tr => tr.classList.remove('table-active'));
        document.getElementById(`seq-row-${sequenceId}`).classList.add('table-active');
        document.getElementById('viewerContainer').style.display = 'block';
        document.getElementById('noViewerSelected').style.display = 'none';
        document.getElementById('annotationPanelContent').style.display = 'block';
        document.getElementById('noAnnotationSelected').style.display = 'none';

        document.getElementById('viewerSeqName').textContent = currentSequence.id;
        document.getElementById('viewerSeqType').textContent = currentSequence.type;
        document.getElementById('viewerSeqLen').textContent = `${currentSequence.length} bp`;
        
        renderFeatureMap(currentSequence);
        renderSequenceText(currentSequence);
        renderFeatureList(currentSequence);
    }

    function renderFeatureMap(seq) {
        const container = document.getElementById('featureMapContainer');
        const seqLen = seq.length;
        const lanes = seq.feature_lanes || [];

        let rulerHtml = '<div class="ruler-track">';
        const numTicks = Math.min(10, Math.floor(seqLen / 20));
        for (let i = 0; i <= numTicks; i++) {
            const pos = (i / numTicks) * 100;
            const label = Math.round((i / numTicks) * seqLen) || 1;
            rulerHtml += `<div class="ruler-tick" style="left: ${pos}%;"></div>`;
            rulerHtml += `<div class="ruler-label" style="left: ${pos}%;">${label}</div>`;
        }
        rulerHtml += '</div>';

        let lanesHtml = '<div class="lanes-container">';
        lanes.forEach(lane => {
            lanesHtml += '<div class="feature-lane">';
            lane.forEach(feature => {
                const left = ((feature.start - 1) / seqLen) * 100;
                const width = ((feature.end - feature.start + 1) / seqLen) * 100;
                lanesHtml += `
                    <div class="feature-element" style="left: ${left}%; width: ${width}%; background-color: ${feature.color};" title="${feature.label || feature.type} (${feature.start}-${feature.end})">
                        <span class="feature-label-text">${feature.label || feature.type}</span>
                    </div>
                `;
            });
            lanesHtml += '</div>';
        });
        lanesHtml += '</div>';

        container.innerHTML = rulerHtml + lanesHtml;
    }

    function renderSequenceText(seq) {
        const container = document.getElementById('sequenceTextContainer');
        const s = seq.sequence || '';
        const lineLen = 60;
        let html = '';
        for (let i = 0; i < s.length; i += lineLen) {
            const idx = (i + 1).toString().padStart(6, ' ');
            const chunk = s.substring(i, i + lineLen);
            html += `<div class="seq-line"><span class="seq-idx">${idx}</span>`;
            for (const char of chunk) {
                html += `<span class="seq-base">${char}</span>`;
            }
            html += '</div>';
        }
        container.innerHTML = html;
    }
    
    function clearViewer() {
        document.getElementById('viewerContainer').style.display = 'none';
        document.getElementById('noViewerSelected').style.display = 'block';
        document.getElementById('annotationPanelContent').style.display = 'none';
        document.getElementById('noAnnotationSelected').style.display = 'block';
        currentSequence = null;
    }

    // --- Import / Export ---
    function showImportModal() {
        const select = document.getElementById('importProjectSelect');
        if (projects.length === 0) {
            select.innerHTML = '<option value="">No projects available</option>';
        } else {
            select.innerHTML = projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }
        importModalInstance.show();
    }

    async function performImport() {
        const projectId = document.getElementById('importProjectSelect').value;
        if (!projectId) {
            showAlert('warning', 'Please select a project to import into.');
            return;
        }

        const formData = new FormData();
        formData.append('project_id', projectId);
        
        const source = document.querySelector('input[name="importSource"]:checked').value;
        formData.append('source', source);

        if (source === 'file') {
            const fileInput = document.getElementById('importFileInput');
            if (fileInput.files.length === 0) {
                showAlert('warning', 'Please select a file to upload.');
                return;
            }
            formData.append('file', fileInput.files[0]);
        } else {
            const text = document.getElementById('importTextArea').value;
            if (!text.trim()) {
                showAlert('warning', 'Please paste FASTA text to import.');
                return;
            }
            formData.append('text', text);
        }

        const spinner = document.getElementById('importSpinner');
        spinner.classList.remove('d-none');

        const data = await apiRequest(API_URLS.import, 'POST', formData, true);
        
        spinner.classList.add('d-none');

        if (data && data.success) {
            showAlert('success', data.message || 'Import successful!');
            importModalInstance.hide();
            // Refresh project list and select the project
            await loadProjects();
            renderProjectTree();
            await selectProject(projectId);
        }
    }

    // --- Other Modals & Actions ---
    function showCreateProjectModal() {
        createProjectModalInstance.show();
    }

    async function createNewProject() {
        const name = document.getElementById('newProjectName').value.trim();
        const description = document.getElementById('newProjectDesc').value.trim();
        if (!name) {
            showAlert('warning', 'Project name is required.');
            return;
        }
        const data = await apiRequest(API_URLS.createProject, 'POST', { name, description });
        if (data && data.success) {
            showAlert('success', data.message);
            createProjectModalInstance.hide();
            await loadProjects();
            renderProjectTree();
            await selectProject(data.project.id);
        }
    }
    
    // Stubs for remaining functionality
    function showAlert(type, msg) { console.log(`Alert (${type}): ${msg}`); }
    function exportCurrentProject() { alert("Export needs refactoring"); }
    function editSequenceContent() { alert("Edit needs refactoring"); }
    function saveAnnotationNotes() { alert("Save notes needs refactoring"); }
    function addFeatureFromForm() { alert("Add feature needs refactoring"); }
    function renderFeatureList(seq) { /* TODO */ }
    function deleteSequence(id) { alert('Delete needs refactoring'); }
    
</script>
{% endblock %}
